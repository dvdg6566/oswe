# DNN Vulnerability

The entry point for the vulnerability is found in the function `LoadProfile`, which is implemented in the `DotNetNuke.dll` module in the `DotNetNuke.Services.Personalization.PersonalizationController` namespace.  

## Code Inspection: Load Profile

Code decompilation in dnSpy: `File â€”> Open menu`. We select the file from the web root `C:\inetpub\wwwroot\dotnetnuke\bin` and select the file `DotNetNuke.dll`.

The **LoadProfile** function can be triggered any time we visit a nonexistent page within the application. The function checks for the cookie named `DNNPersonalization` and if present, its value is assigned to the local `text` string value, which is then passed into the `DeserializeHashTableXml`function.  

```java
// Vulnerable Code:
public PersonalizationInfo LoadProfile (int userId, int portalId){
	PersonalizationInfo personalizationInfo = new PersonalizationInfo{
		UserId = userId,
		PortalId = portalId,
		IsModified = False	
	}
	string text = Null.NullString;
	if (userId > Null.NullInteger){ // If user exists
		string key = string.Format("UserPersonalization|{0}|{1}", portalId, userId);
		text = CBO.GetCachedObject<string>(new CacheItemsArgs(key, 5, CacheItemPriority.Normal, new object[]{
			portalId, userId
		}), new CacheItemExpiredCallback(PersonalizationController.GetCachedUserPersonalizationCallback));
	}
	else{ // User does not exist
		HttpContext httpContext = HttpContext.Current;
		if (httpContext != null && httpContext.Request.Cookies["DNNPersonalization"] != null){
			text = httpContext.Request.Cookies["DNNPersonalization"].Value;
		}
	}
	personalizationInfo.Profile = (string.IsNullOrEmpty(text)?new Hashtable(): Globals.DeserializeHashTableXml(text));
	return personalizationInfo;
}
```

## Code Inspection: DeserializeHashTable

We can click on the `globals.DeSerializeHashTableXML` function to trace its source path. It hardcodes the value profile as the second argument, and then routes us to another function in `XMLUtils`. 

```java
public static Hashtable DeserializeHashTableXml (string Source){
	return XMLUtils.DeSerializeHashtable(Source, "profile");
}
```

The following code is the implementation of the `DeSerializeHashTable` function. No **type checking** is performed on the input object during deserialization. 

1. Looks for each item in under the profile root XML tag
2. Creates XML Serializer based on the XML element type
3. Creates XML text reader using the XML contents of the object
4. Adds into a hash table

```java
public static Hashtable DeSerializeHashTable (string xmlSource, string rootname){
	// rootname is hardcoded to be equal to "profile"
	Hashtable hashtable = new Hashtable();
	if (!string.IsNullOrEmpty(xmlSource)){
		try{
			XMLDocument xmlDocument = new XmlDocument();
			xmlDocument.LoadXml(xmlSource);
			foreach (object obj in xmlDocument.SelectNodes(rootname + "/item")){
				XmlElement xmlElement = (XmlElement)obj;
				string attribute = xmlElement.GetAttribute("key");
				string attribute2 = xmlElement.GetAttribute("type");
				XmlSerializer xmlSerializer = new xmlSerializer(Type.GetType(attribute2));
				XmlTextReader xmlReader = new XmlTextReader(new StringReader(xmlElement.InnerXml));
				hashtable.Add(attribute, xmlSerializer.Deserialize(xmlReader));
			}
		}
		catch(Execption){}
	}
}
```

## Constructing Payload

DNNPersonalization cookie has to be in specific format that contains profile node along with item tag that contains a type attribute describing the enclosed object.